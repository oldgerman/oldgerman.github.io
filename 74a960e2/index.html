<!DOCTYPE html>





<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">
  <meta name="google-site-verification" content="F_-gJswV8w9zL1mCRsfDqRogO9gml_HMXr_uLczMHcE">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="解读ironOS开源烙铁固件：如何使用加速度计实现运动唤醒和oled旋转">
<meta name="keywords" content="加速度计">
<meta property="og:type" content="article">
<meta property="og:title" content="ODGIRON LIS3DH笔记">
<meta property="og:url" content="http://oldgerman.github.io/74a960e2/index.html">
<meta property="og:site_name" content="OldGerman&#39;s Blog">
<meta property="og:description" content="解读ironOS开源烙铁固件：如何使用加速度计实现运动唤醒和oled旋转">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/TS100-72%E5%8F%98(1).png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/TS100-72%E5%8F%98(2).png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/TS100-guts2-525px.jpg">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/LIS2DH12-LC.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/LIS3DH-LC.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/LIS2DH12-LC.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/LIS3DH-LC-BK.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/LIS2DH12-LC-BK.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/ironOS%E7%9A%84%E5%8A%A0%E9%80%9F%E5%BA%A6%E8%AE%A1-%E5%89%A7%E7%83%88%E6%91%87%E6%99%83%EF%BC%8C%E5%B0%86%E8%AF%BB%E6%95%B0%E5%B7%A6%E7%A7%BB%E4%BD%8D4bit%E8%BF%90%E7%AE%97%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/3%E8%BD%B4%E6%95%B0%E6%8D%AE%E9%80%9A%E8%BF%87%E9%AB%98%E9%80%9A%E6%BB%A4%E6%B3%A2%E5%99%A8.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/ironOS%E7%9A%84%E5%8A%A0%E9%80%9F%E5%BA%A6%E8%AE%A1-%E6%AD%A3%E5%B8%B8%E9%9D%99%E7%BD%AE.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/LIS3DH%E8%BD%B4%E5%90%91.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/LIS2DH12%E8%BD%B4%E5%90%91.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/%E5%8F%B3%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(1).png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/%E5%8F%B3%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(2).png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/%E5%B7%A6%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(2).png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/%E5%B7%A6%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(1).png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/0x28%E5%B7%A6%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/0x28%E5%8F%B3%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/0x20%E5%B7%A6%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/0x20%E5%8F%B3%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/50DEC%E5%B7%A6%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/50DEC%E5%8F%B3%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/sw.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/GeoGebra_x%E8%BD%B4%E5%92%8Cz%E8%BD%B4%E8%AF%BB%E6%95%B0%E9%9A%8F%E7%BB%95y%E8%BD%B4%E8%A7%92%E5%BA%A6%E7%9A%84%E5%85%B3%E7%B3%BB.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/currentPointer%E9%9A%8FMOVTAsk%E8%B0%83%E5%BA%A6%E6%AC%A1%E6%95%B0%E5%8F%98%E5%8C%96.png">
<meta property="og:image" content="http://oldgerman.github.io/74a960e2/%E4%B8%80%E8%BE%B96D%E6%97%8B%E8%BD%AC%E9%98%88%E5%80%BC%E6%A3%80%E6%B5%8B%E4%B8%80%E8%BE%B9%E8%BF%90%E5%8A%A8%E6%A3%80%E6%B5%8B%E7%9A%84%E7%9E%AC%E9%97%B4.png">
<meta property="og:updated_time" content="2024-04-03T04:03:42.226Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ODGIRON LIS3DH笔记">
<meta name="twitter:description" content="解读ironOS开源烙铁固件：如何使用加速度计实现运动唤醒和oled旋转">
<meta name="twitter:image" content="http://oldgerman.github.io/74a960e2/TS100-72%E5%8F%98(1).png">
  <link rel="canonical" href="http://oldgerman.github.io/74a960e2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ODGIRON LIS3DH笔记 | OldGerman's Blog</title>
  <meta name="generator" content="Hexo 3.9.0">
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">OldGerman's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">大道天工</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-首页">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-分类">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-标签">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-归档">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-站点地图">
      
    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-wrapper">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content page-post-detail">
            

  <div id="posts" class="posts-expand">
    

  <article class="post" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldgerman.github.io/74a960e2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="过气德国佬">
      <meta itemprop="description" content="潮起潮落，云卷云舒">
      <meta itemprop="image" content="/images/OldGerman.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OldGerman's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">ODGIRON LIS3DH笔记

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2021-02-17 00:03:36" itemprop="dateCreated datePublished" datetime="2021-02-17T00:03:36+08:00">2021-02-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-03 12:03:42" itemprop="dateModified" datetime="2024-04-03T12:03:42+08:00">2024-04-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ODGIRON/" itemprop="url" rel="index"><span itemprop="name">ODGIRON</span></a></span>

                
                
              
            </span>
          

          
            <span id="/74a960e2/" class="post-meta-item leancloud_visitors" data-flag-title="ODGIRON LIS3DH笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/74a960e2/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/74a960e2/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>7.3k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>7 分钟</span>
            </span>
          
            <div class="post-description">解读ironOS开源烙铁固件：如何使用加速度计实现运动唤醒和oled旋转</div>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="ts100的两个加速度计"><a class="markdownIt-Anchor" href="#ts100的两个加速度计"></a> TS100的两个加速度计</h2><p>基于IronOS固件的典型烙铁，比如TS100的PCB预留了两种加速度计焊盘，一种是NXP的MMA系列的MMA8652FC加速度计，一种是ST的LIS系列的LIS2DH12加速度计，实际出货时只焊接一个（这么做应该是和采购有关），大多数TS100仅焊接的是LIS2DH12加速度计，其封装为 LGA12(2.0x2.0x1.0 mm)，焊盘之间实在距离太小了，又是LGA封装，和QFN封装能侧面爬锡不同，LGA封装仅底面开了焊盘，侧面无法爬锡，从网上找到TS100的PCB的加速度计如下：</p><a id="more"></a>

<table>
<thead>
<tr>
<th>TS100采用双PCB设计</th>
<th>小PCB通过板对板连接器与大PCB连接</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/74a960e2/TS100-72%E5%8F%98(1).png" alt="TS100-72变(1)"></td>
<td><img src="/74a960e2/TS100-72%E5%8F%98(2).png" alt="TS100-72变(2)"></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>小PCB右加速计和STM32</th>
<th>确认型号与LC商城的LIS2DH12一致</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/74a960e2/TS100-guts2-525px.jpg" alt="TS100-guts2-525px"></td>
<td><img src="/74a960e2/LIS2DH12-LC.png" alt="LIS2DH12-LC"></td>
</tr>
</tbody>
</table>
<h2 id="lis3dh与lis2dh12"><a class="markdownIt-Anchor" href="#lis3dh与lis2dh12"></a> LIS3DH与LIS2DH12</h2>
<p><a href="https://oldgerman.github.io/d5ffc54/">ODGIRON</a>，是我最近在开发的基于ironOS的快充T12电烙铁，由于ODGIRON双面布线，加速度盘下要走两个过孔才能布通，因此选用了封装更大的LIS3DH，封装为LGA12(3.0x3.0x1.0 mm)，其焊接更友好，还更便宜，需要用到的地方与LIS2DH12几乎完全一致，要什么自行车</p>
<table>
<thead>
<tr>
<th></th>
<th>LIS3DH</th>
<th>LIS2DH12</th>
</tr>
</thead>
<tbody>
<tr>
<td>尺寸</td>
<td><img src="/74a960e2/LIS3DH-LC.png" alt="LIS3DH-LC"></td>
<td><img src="/74a960e2/LIS2DH12-LC.png" alt="LIS2DH12-LC"></td>
</tr>
<tr>
<td></td>
<td><img src="/74a960e2/LIS3DH-LC-BK.png" alt="LIS3DH-LC-BK"></td>
<td><img src="/74a960e2/LIS2DH12-LC-BK.png" alt="LIS2DH12-LC-BK"></td>
</tr>
<tr>
<td>供电电压</td>
<td>1.71 V to 3.6 V</td>
<td>1.71 V to 3.6 V</td>
</tr>
<tr>
<td>50Hz正常工作电流(uA)</td>
<td>11</td>
<td>11</td>
</tr>
<tr>
<td>量程（FS）</td>
<td>±2g/±4g/±8g/±16g</td>
<td>±2g/±4g/±8g/±16g</td>
</tr>
<tr>
<td>量程特性</td>
<td><span style="color:rgb(255, 128, 255);">dynamically</span> selectable full scale</td>
<td>selectable full scales</td>
</tr>
<tr>
<td>接口</td>
<td>I2C/SPI</td>
<td>I2C/SPI</td>
</tr>
<tr>
<td>可编程中断GPIO</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>中断GPIO功能</td>
<td>free-fall and motion detection</td>
<td>free-fall and motion detection</td>
</tr>
<tr>
<td>硬件方向检测</td>
<td>6D/4D orientation detection</td>
<td>6D/4D orientation detection</td>
</tr>
<tr>
<td>数据位数(bit)</td>
<td>Low-power mode (8-bit data output)<br>Normal mode (10-bit data output)<br>High-resolution mode (12-bit data output)</td>
<td>Low-power mode (8-bit data output)<br>Normal mode (10-bit data output)<br>High-resolution mode (12-bit data output)</td>
</tr>
<tr>
<td>输出数据位数</td>
<td>12bit/10bit/8bit</td>
<td>12bit/10bit/8bit</td>
</tr>
<tr>
<td>片上温度传感器</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>自检</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><span style="color:rgb(255, 128, 255);">FIFO</span></td>
<td>16-bit, 32-level</td>
<td>10-bit, 32-level</td>
</tr>
<tr>
<td>ADC</td>
<td>多一路A/D converter<br>引出3路ADC GPIO</td>
<td>仅一路A/D converter</td>
</tr>
<tr>
<td><span style="color:rgb(255, 128, 255);">抗震性(g)</span></td>
<td>10000</td>
<td>N/A</td>
</tr>
<tr>
<td>Datasheet一样的参数</td>
<td>Mechanical characteristics<br>Temperature sensor characteristics<br>Electrical characteristics<br>Communication interface characteristics<br>Absolute maximum ratings<br>Terminology and functionality</td>
<td></td>
</tr>
<tr>
<td><span style="color:rgb(255, 128, 255);">最低价格</span></td>
<td>1.3包邮</td>
<td>2.3包邮</td>
</tr>
</tbody>
</table>
<h2 id="ironos-加速度计读数不正常问题解决"><a class="markdownIt-Anchor" href="#ironos-加速度计读数不正常问题解决"></a> ironOS 加速度计读数不正常问题解决</h2>
<p>ironOS跑了FreeRTOS，加速度计为MOVTask任务，与oled的GUITask共用 I2C1 总线，由二值信号量做 I2C1 互斥，具体实现请见ironOS源码</p>
<p>ironOS的LISDH12的加速度计驱动代码有BUG，它配置了一大堆非必要的加速度计寄存器，而实际上任务仅用到读取3轴数据和6D检测，我仔细跟了它原本的寄存器配置，得出LISDH12工作状态如下：</p>
<ul>
<li>输出数据：12bit，即 [-2048, +2048]</li>
<li>加速度量程：±2g</li>
<li>ODR：1Hz，实际上注释是想配置成25Hz，但它实际的配置数据位写错了</li>
<li>实际加速度输出频率：当ODR=1，ODR/9 = 0.111次/秒，运动检测很迟钝</li>
<li>期望的加速度输出频率：当ODR=25，ODR/9 = 2.777次/秒，运动检测较迟钝</li>
<li>ODGIRON设置的加速度输出频率：ODR为100Hz，ODR/9=11.111次/秒，与MOVTask调度频率10Hz几乎同步，运动检测很灵敏</li>
</ul>
<p>其运动检测的源代码：ironOS运动检测是由MOVTask里跑了一个阈值比较程序，它实现了运动检测，既然软件进行了运动检测，那为啥还要使能6D阈值检测的事件中断？</p>
<p>ironOS读取加速度计的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  读取三轴数据</span></span><br><span class="line"><span class="comment"> * @param  传x、y、z数据的引用</span></span><br><span class="line"><span class="comment"> * @retval none</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LIS2DH12::getAxisReadings</span><span class="params">(<span class="keyword">int16_t</span> &amp;x, <span class="keyword">int16_t</span> &amp;y, <span class="keyword">int16_t</span> &amp;z)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">int16_t</span>, 3&gt; sensorData;	<span class="comment">//三组16bit用于存储三个轴12bit数据</span></span><br><span class="line"></span><br><span class="line">  FRToSI2C::Mem_Read(</span><br><span class="line">truetrue  	  	  	  LIS2DH_I2C_ADDRESS,</span><br><span class="line">truetrue  	  	  	  <span class="number">0xA8</span>,	<span class="comment">//注意，0xA8是OUT_X_L的0x28 与 连续读取的0x80 两者按位与运算得到的</span></span><br><span class="line">      						<span class="comment">//这里它连续读取 OUT_X_L 到 OUT_Z_H 共六个相邻的只读寄存器</span></span><br><span class="line">truetruetruetruetrue  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span> *&gt;(sensorData.<span class="built_in">begin</span>()), <span class="comment">// 将定位到容器首元素iterator强制转换为unit8_t*,炫技操作？</span></span><br><span class="line">truetruetruetruetrue  sensorData.<span class="built_in">size</span>() * <span class="keyword">sizeof</span>(<span class="keyword">int16_t</span>)</span><br><span class="line">truetruetruetruetrue);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//依次赋值</span></span><br><span class="line">  x = sensorData[<span class="number">0</span>];</span><br><span class="line">  y = sensorData[<span class="number">1</span>];</span><br><span class="line">  z = sensorData[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于12bit数据是左对齐的，可见，在 //依次赋值 的地方，未作 &gt;&gt; 4 运算，直接输出的xyz结果范围不是[-2048, +2048]，而是有时候数据能到 ±10000以外，离谱</p>
<p>我补上 &gt;&gt; 4运算，使劲晃动时输出数据也不正常，很难到 ±2000附近：</p>
<p><img src="/74a960e2/ironOS%E7%9A%84%E5%8A%A0%E9%80%9F%E5%BA%A6%E8%AE%A1-%E5%89%A7%E7%83%88%E6%91%87%E6%99%83%EF%BC%8C%E5%B0%86%E8%AF%BB%E6%95%B0%E5%B7%A6%E7%A7%BB%E4%BD%8D4bit%E8%BF%90%E7%AE%97%E7%BB%93%E6%9E%9C.png" alt="ironOS的加速度计-剧烈摇晃，将读数左移位4bit运算结果"></p>
<p>这与arduino的Sparkfun 的LIS3DH例程非常不同，arduino的例程跑起来，若水平放置加速度计，z方向会在-1024附近，即能显示地球的重力加速度1g，奇怪的是ironOS的跑起来没有1g的加速度，读出数据如下：</p>
<p><img src="/74a960e2/3%E8%BD%B4%E6%95%B0%E6%8D%AE%E9%80%9A%E8%BF%87%E9%AB%98%E9%80%9A%E6%BB%A4%E6%B3%A2%E5%99%A8.png" alt="20210220005151"></p>
<p>这是为什么呢？排查出错原因是仅配置了LIS_CTRL_REG2的FDS位，使能了High-pass filter ，这之后输出的三轴数据，是经高通滤波后的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;LIS_CTRL_REG2, <span class="number">0b00001000</span>, <span class="number">0</span>&#125;, <span class="comment">//default：00000000 // Highpass filter off          // 		 FDS[3:3] = 1：</span></span><br><span class="line"><span class="comment">//筛选数据选择。默认值：0</span></span><br><span class="line"><span class="comment">// 0：绕过内部滤波器</span></span><br><span class="line"><span class="comment">// 1：来自内部滤波器的数据发送到输出寄存器和FIFO</span></span><br></pre></td></tr></table></figure>
<p>我将该配置取消掉，之后水平静置读数正常，换算z方向的加速度是正常的1g左右：</p>
<p><img src="/74a960e2/ironOS%E7%9A%84%E5%8A%A0%E9%80%9F%E5%BA%A6%E8%AE%A1-%E6%AD%A3%E5%B8%B8%E9%9D%99%E7%BD%AE.png" alt></p>
<p>实际上，后面运动检测也可以读经过高通滤波器的值，ironOS没有将经过高通滤波器的值 做&lt;&lt;4运算，即实际传入运动检测程序的值大了2^4 = 16倍，这就能解释为啥我默认打印xyz读到的数据剧烈晃动时可以到±10000，能触发运动检测，但&lt;&lt;4后摇晃时读数稳如泰山，摇晃得很厉害也无法触发运动检测</p>
<p>所以，是否按ironOS的原始代码启用高通滤波器看你的喜好，个人感觉数据不过滤波器运动检测舒服一些</p>
<p>注意：数据经过滤波器对6D阈值无影响，6D阈值是取原始读数的</p>
<p>LIS3DH的滤波器还有很多高级特性供配置，可以作用于中断、敲击检测，更多请参考手册的 8.9节 CTRL_REG2 (21h)</p>
<h2 id="根据加速读计旋转oled"><a class="markdownIt-Anchor" href="#根据加速读计旋转oled"></a> 根据加速读计旋转oled</h2>
<p>LIS3DH带有6D阈值事件中断功能。</p>
<h3 id="加速度计坐标轴"><a class="markdownIt-Anchor" href="#加速度计坐标轴"></a> 加速度计坐标轴</h3>
<p>注意TS100的LIS2DH12和我ODGIRON的LIS3DH的轴向坐标不同：</p>
<table>
<thead>
<tr>
<th></th>
<th>LIS3DH</th>
<th>LIS2DH12</th>
</tr>
</thead>
<tbody>
<tr>
<td>轴向</td>
<td><img src="/74a960e2/LIS3DH%E8%BD%B4%E5%90%91.png" alt="LIS3DH轴向"></td>
<td><img src="/74a960e2/LIS2DH12%E8%BD%B4%E5%90%91.png" alt="LIS2DH12轴向"></td>
</tr>
</tbody>
</table>
<p>我对原本TS100的 LIS3DH::getOrientation() 函数进行修改，使之符合LIS3DH的坐标轴，明细请见源代码。</p>
<h3 id="右手与左手的旋转与加速度计坐标关系"><a class="markdownIt-Anchor" href="#右手与左手的旋转与加速度计坐标关系"></a> 右手与左手的旋转与加速度计坐标关系</h3>
<p>我根据加速度计相对烙铁的安装的位置，画了ODGIRON和TS100的加速读坐标两张纸贴在烙铁上，下文都按照左边ODGIRON贴纸上的坐标</p>
<table>
<thead>
<tr>
<th>右手模式水平静置</th>
<th>右手模式旋转 +90°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/74a960e2/%E5%8F%B3%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(1).png" alt="右手模式旋转(1)"></td>
<td><img src="/74a960e2/%E5%8F%B3%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(2).png" alt="右手模式旋转(2)"></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>左手模式水平静置</th>
<th>左手模式旋转 -90°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/74a960e2/%E5%B7%A6%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(2).png" alt="左手模式旋转(2)"></td>
<td><img src="/74a960e2/%E5%B7%A6%E6%89%8B%E6%A8%A1%E5%BC%8F%E6%97%8B%E8%BD%AC(1).png" alt="左手模式旋转(1)"></td>
</tr>
</tbody>
</table>
<h3 id="int2_ths-阈值寄存器"><a class="markdownIt-Anchor" href="#int2_ths-阈值寄存器"></a> INT2_THS 阈值寄存器</h3>
<p>THS 即 threshold 阈值</p>
<p>ironOS 的 <code>INT2_THS</code> 寄存器 设置值为0x28，根据datasheet：</p>
<ul>
<li>
<p>由 Table 68. <code>INT2_THS</code> description：LIS3DH工作在12bit ±2g，则 THS[6:0] 的 1LSB = 16mg，计算触发阈值：先将0x28转换为10进制：0x28 = 40DEC ,  再乘以16msg 得到触发阈值为±640mg，</p>
</li>
<li>
<p>由 Table 4. Mechanical characteristics的Sensitivity部分：LIS3DH工作在12bit ±2g时 ，加速度输出数据的1LSB = 1mg，则读数为±640触发临界点</p>
</li>
</ul>
<p>测试，0x28的640mg实际旋转触发时以z轴值主导，z的阈值为±640附近，而x阈值为±830附近：</p>
<table>
<thead>
<tr>
<th>左手阈值触发临界点附近：</th>
<th>右手阈值触发临界点附近：</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/74a960e2/0x28%E5%B7%A6%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png" alt="0x28左手阈值触发临界点"></td>
<td><img src="/74a960e2/0x28%E5%8F%B3%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png" alt="0x28右手阈值触发临界点.png"></td>
</tr>
</tbody>
</table>
<p>将0x28改为0x20，0x20为512mg，实际旋转触发时以z轴值主导，z的阈值为±640附近，x阈值为±910附近：</p>
<table>
<thead>
<tr>
<th>左手阈值触发临界点附近：</th>
<th>右手阈值触发临界点附近：</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/74a960e2/0x20%E5%B7%A6%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png" alt="20210219234731"></td>
<td><img src="/74a960e2/0x20%E5%8F%B3%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png" alt="20210219234715"></td>
</tr>
</tbody>
</table>
<p>改为50，50为800mg，实际旋转触发时以x轴值为主导，z的阈值为±640附近，x阈值为±800附近：</p>
<table>
<thead>
<tr>
<th>左手阈值触发临界点附近：</th>
<th>右手阈值触发临界点附近：</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="/74a960e2/50DEC%E5%B7%A6%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png" alt="20210220000410"></td>
<td><img src="/74a960e2/50DEC%E5%8F%B3%E6%89%8B%E9%98%88%E5%80%BC%E8%A7%A6%E5%8F%91%E4%B8%B4%E7%95%8C%E7%82%B9.png.png" alt="20210220000425"></td>
</tr>
</tbody>
</table>
<p>所以这很奇怪，<code>INT2_THS</code>的值可能由z轴也可能为x轴的阈值事件触发，但最终手性的判断是OK的</p>
<h3 id="那么旋转oled阈值事件到底是以x还是z轴触发判断"><a class="markdownIt-Anchor" href="#那么旋转oled阈值事件到底是以x还是z轴触发判断"></a> 那么旋转oled阈值事件到底是以x还是z轴触发判断？</h3>
<p>设xoy面水平，即烙铁屏幕水平，当烙铁沿y轴旋转时，z轴加速度读数 与 旋转角度 存在函数关系，推导一下</p>
<p>规定屏幕水平向上时，沿y轴的旋转角度为0，则烙铁沿y轴旋转时，垂直于屏幕的法线与旋转角度为0时的法线存在夹角θ，令该法线通过原点，则该法线的参数方程为：
<span></span></p>
<p class="katex-block katex-error" title="ParseError: KaTeX parse error: No such environment: align at position 15: \left\{
\begin{̲a̲l̲i̲g̲n̲}̲
x&amp;=tcos(\frac{…">\left\{
\begin{align}
x&amp;=tcos(\frac{\pi}{2}-\theta)\\
y&amp;=tsin(\frac{\pi}{2}-\theta)\\
\end{align}
\right.
\space\space\space\space,\space\space\theta∈[-\frac{\pi}{2},\frac{\pi}{2}]
</p>

如图所示，建立与x轴加速度读数有关的圆，直径是1g时，读数为1024，则半径为512，那么该的圆的方程为：
<span>
$$
x^2+(y-512)^2=512^2
$$
</span>
该圆上任一点 (x,y) 到原点 (0,0) 的距离为：
<span>
$$
d=\sqrt{x^2+y^2}
$$
</span>
联立以上公式得：
<span>
$$
\left\{
\begin{align}
x&=tcos(\frac{\pi}{2}-\theta)\\
y&=tsin(\frac{\pi}{2}-\theta)\\
x^2+(y-512)^2&=512^2\\
d&=\sqrt{x^2+y^2}\\
\end{align}
\right.
\space\space\space\space,\space\space\theta∈[-\frac{\pi}{2},\frac{\pi}{2}]
$$
</span>
易整理得：
$$
d=1024\cdot sin(\frac{\pi}{2}-\theta) \space\space\space\space,\space\space\theta∈[-\frac{\pi}{2},\frac{\pi}{2}]
$$
 由于z轴于屏幕显示方向刚好相反，所以
$$
z轴加速度读数=-1024\cdot sin(\frac{\pi}{2}-\theta) \space\space\space\space,\space\space\theta∈[-\frac{\pi}{2},\frac{\pi}{2}]
$$
<p>类似地，可以写出：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>x</mi><mtext>轴加速度读数</mtext><mo>=</mo><mn>1024</mn><mo>⋅</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mtext>    </mtext><mo separator="true">,</mo><mtext>  </mtext><mi>θ</mi><mo>∈</mo><mo stretchy="false">[</mo><mo>−</mo><mfrac><mi>π</mi><mn>2</mn></mfrac><mo separator="true">,</mo><mfrac><mi>π</mi><mn>2</mn></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x轴加速度读数=1024\cdot sin(\theta) \space\space\space\space,\space\space\theta∈[-\frac{\pi}{2},\frac{\pi}{2}]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">x</span><span class="mord cjk_fallback">轴</span><span class="mord cjk_fallback">加</span><span class="mord cjk_fallback">速</span><span class="mord cjk_fallback">度</span><span class="mord cjk_fallback">读</span><span class="mord cjk_fallback">数</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">]</span></span></span></span></span></p>
<p>那么把旋转角度θ带入x轴加速度读数函数求得的值，再由 THS[6:0] 的 1LSB = 16mg 计算触发阈值，设置为<code>INT2_THS</code>的值，就可指定旋转角度触发中断了</p>
<p><img src="/74a960e2/sw.png" alt="sw"></p>
<p>可以画出x轴和z轴读数随沿y轴旋转角度（-90度到90度）的图像：</p>
<p><img src="/74a960e2/GeoGebra_x%E8%BD%B4%E5%92%8Cz%E8%BD%B4%E8%AF%BB%E6%95%B0%E9%9A%8F%E7%BB%95y%E8%BD%B4%E8%A7%92%E5%BA%A6%E7%9A%84%E5%85%B3%E7%B3%BB.png" alt></p>
<p>发现x与z轴的事件 受<code>INT2_THS</code>的值范围 会出现先后触发的情况，在<code>x=-π/4</code>或<code>x=π/4</code>的附近，即旋转<code>-45</code>度和<code>45</code>度附近，在<code>-45</code>度的左边时，z轴比x轴先触发，在<code>-45</code>度右边时，则相反，但实际x轴和z轴事件的先后顺序却相反，应该是加速度计片内电路判断成反序了</p>
<p>注意：使能了IN2中断锁存：LIR_INT2[7:7] = 1：在INT2_SRC（35h）寄存器上锁存中断请求，对此没有影响</p>
<p>为了最佳旋转触发，我<code>45</code>度作为临界点：</p>
<span>
$$
1024\cdot sin(\pi/2)≈724.08
$$
</span>
<p>然后再除以寄存器的分辨率16mg/LSB：</p>
<span>
$$
724.08/16≈45
$$
</span>
<p>那么将<code>INT2_THS</code>设置为45即可</p>
<p>剩下oled驱动、旋转oled的命令不是重点，略</p>
<h3 id="int2_duration寄存器有没有用"><a class="markdownIt-Anchor" href="#int2_duration寄存器有没有用"></a> INT2_DURATION寄存器有没有用？</h3>
<p>会增加一个消抖时间，可开可不开，实际效果无明显变化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*开了没开一样，没卵用？*/</span>	&#123;LIS_INT2_DURATION, <span class="number">64</span>, <span class="number">0</span>&#125;,    <span class="comment">//default：00000000 // 64 = 0b01000000	// 超出阈值持续多少时间才触发INT2的中断（相当于按键延时消抖）</span></span><br></pre></td></tr></table></figure>
<h2 id="运动检测"><a class="markdownIt-Anchor" href="#运动检测"></a> 运动检测</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">currentPointer = (currentPointer + <span class="number">1</span>) % MOVFilter <span class="comment">// 每8次MOVTask调度，currentPointer归0</span></span><br></pre></td></tr></table></figure>
<p>串口打印currentPointer随MOVTAsk调度次数变化：ptr是currentPointer， time是调度次数</p>
<p><img src="/74a960e2/currentPointer%E9%9A%8FMOVTAsk%E8%B0%83%E5%BA%A6%E6%AC%A1%E6%95%B0%E5%8F%98%E5%8C%96.png" alt="20210220230512"></p>
<p>读到的轴数据在滑动滤波器数组里的变化情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第1次：</span></span><br><span class="line">currentPointer = <span class="number">0</span></span><br><span class="line">datax[] = &#123;<span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>&#125;	<span class="comment">//首次会将每一个元素都赋值为第一次的x轴数据，之后不会</span></span><br><span class="line"><span class="comment">//         ^    ^     ^    ^    ^    ^    ^    ^</span></span><br><span class="line"><span class="comment">//     第1次 第1次 第1次 第1次 第1次 第1次 第1次 第1次</span></span><br><span class="line"><span class="comment">//第2次：</span></span><br><span class="line">currentPointer = <span class="number">1</span></span><br><span class="line">datax[] = &#123;<span class="number">111</span>, <span class="number">222</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">111</span>&#125;</span><br><span class="line"><span class="comment">//         ^    ^     ^    ^    ^    ^    ^    ^</span></span><br><span class="line"><span class="comment">//     第1次 第2次 第1次 第1次 第1次 第1次 第1次 第1次</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">//第7次：</span></span><br><span class="line">currentPointer = <span class="number">7</span></span><br><span class="line">datax[] = &#123;<span class="number">111</span>, <span class="number">222</span>, <span class="number">333</span>, <span class="number">444</span>, <span class="number">555</span>, <span class="number">666</span>, <span class="number">777</span>, <span class="number">111</span>&#125;	<span class="comment">//xxx表示x轴的随机取值</span></span><br><span class="line"><span class="comment">//         ^    ^     ^    ^    ^    ^    ^    ^</span></span><br><span class="line"><span class="comment">//     第1次 第2次 第3次 第4次 第5次 第6次 第7次 第1次</span></span><br><span class="line"><span class="comment">//第8次：</span></span><br><span class="line">currentPointer = <span class="number">0</span>	<span class="comment">//整除归零，重新计数</span></span><br><span class="line">datax[] = &#123;<span class="number">111</span>, <span class="number">222</span>, <span class="number">333</span>, <span class="number">444</span>, <span class="number">555</span>, <span class="number">666</span>, <span class="number">777</span>, <span class="number">888</span>&#125;</span><br><span class="line"><span class="comment">//         ^    ^     ^    ^    ^    ^    ^    ^</span></span><br><span class="line"><span class="comment">//     第1次 第2次 第3次 第4次 第5次 第6次 第7次 第8次</span></span><br><span class="line"><span class="comment">//第9次：</span></span><br><span class="line">currentPointer = <span class="number">1</span></span><br><span class="line">datax[] = &#123;<span class="number">999</span>, <span class="number">222</span>, <span class="number">333</span>, <span class="number">444</span>, <span class="number">555</span>, <span class="number">666</span>, <span class="number">777</span>, <span class="number">888</span>&#125;</span><br><span class="line"><span class="comment">//         ^    ^     ^    ^    ^    ^    ^    ^</span></span><br><span class="line"><span class="comment">//     第9次 第2次 第3次 第4次 第5次 第6次 第7次 第8次</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>然后每次求一次8个元素的平均值，即变量avgx，使用<code>abs(avgx - 本次读到的x数据)</code>，得到x轴变化量的绝对值，以同样的方式计算y和z轴，求和为三轴的总变化值，即变量error，将error与threshold比较，若大于，则更新运动检测的时间戳，即变量lastMovementTime，详细见代码，以下节选部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 求三轴变化量绝对值的总和 //Sum the deltas	//abs()求传入数据的绝对值</span></span><br><span class="line"><span class="keyword">int32_t</span> error = (<span class="built_in">abs</span>(avgx - axisData.x) + <span class="built_in">abs</span>(avgy - axisData.y) + <span class="built_in">abs</span>(avgz - axisData.z));</span><br><span class="line"><span class="comment">// So now we have averages, we want to look if these are different by more</span></span><br><span class="line"><span class="comment">// than the threshold</span></span><br><span class="line"><span class="comment">// If movement has occurred then we update the tick timer</span></span><br><span class="line"><span class="comment">// 如果发生了移动，那么我们更新滴答计时器</span></span><br><span class="line"><span class="keyword">if</span> (error &gt; threshold) &#123;</span><br><span class="line">    lastMovementTime = xTaskGetTickCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="综合测试"><a class="markdownIt-Anchor" href="#综合测试"></a> 综合测试</h2>
<p>一边读3轴数据，一边6D旋转阈值检测，一边运动检测的瞬间，OK：</p>
<p><img src="/74a960e2/%E4%B8%80%E8%BE%B96D%E6%97%8B%E8%BD%AC%E9%98%88%E5%80%BC%E6%A3%80%E6%B5%8B%E4%B8%80%E8%BE%B9%E8%BF%90%E5%8A%A8%E6%A3%80%E6%B5%8B%E7%9A%84%E7%9E%AC%E9%97%B4.png" alt="20210220011749"></p>
<h2 id="相关链接"><a class="markdownIt-Anchor" href="#相关链接"></a> 相关链接</h2>
<p><a href="https://oldgerman.github.io/d5ffc54/">ODGIRON_开源PD电烙铁</a></p>
<p><a href="https://github.com/Ralim/IronOS" target="_blank" rel="noopener">IronOS开源烙铁固件github</a></p>
<p><a href="https://www.sohu.com/a/109038400_116463" target="_blank" rel="noopener">美与质量共存——TS100袖珍迷你烙铁评测</a></p>
<p><a href="https://www.analog.com/cn/products/landing-pages/001/accelerometer-specifications-definitions.html#" target="_blank" rel="noopener">AD：加速度计技术规格——快速定义</a></p>
<p><a href="https://www.st.com/resource/en/datasheet/lis3dh.pdf" target="_blank" rel="noopener">LIS3DH Datashee- STMicroelectronics</a></p>
<p><a href="https://www.st.com/resource/en/datasheet/lis2dh12.pdf" target="_blank" rel="noopener">LIS2DH12 Datasheet - STMicroelectronics</a></p>

    </div>

    
    
    
        
      
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>过气德国佬</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://oldgerman.github.io/74a960e2/" title="ODGIRON LIS3DH笔记">http://oldgerman.github.io/74a960e2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>
</div>

      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/加速度计/" rel="tag"># 加速度计</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/c57b1704/" rel="next" title="STM32常见英文单词、术语、缩写等">
                  <i class="fa fa-chevron-left"></i> STM32常见英文单词、术语、缩写等
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/1eb159fd/" rel="prev" title="nRLC音频头版组装指南">
                  nRLC音频头版组装指南 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="comments"></div>
  

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/OldGerman.jpg"
      alt="过气德国佬">
  <p class="site-author-name" itemprop="name">过气德国佬</p>
  <div class="site-description motion-element" itemprop="description">潮起潮落，云卷云舒</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/oldgerman" title="GitHub &rarr; https://github.com/oldgerman" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:2920956602@qq.com" title="E-Mail &rarr; mailto:2920956602@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
  </div>




        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ts100的两个加速度计"><span class="nav-number">1.</span> <span class="nav-text"> TS100的两个加速度计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lis3dh与lis2dh12"><span class="nav-number">2.</span> <span class="nav-text"> LIS3DH与LIS2DH12</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ironos-加速度计读数不正常问题解决"><span class="nav-number">3.</span> <span class="nav-text"> ironOS 加速度计读数不正常问题解决</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#根据加速读计旋转oled"><span class="nav-number">4.</span> <span class="nav-text"> 根据加速读计旋转oled</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#加速度计坐标轴"><span class="nav-number">4.1.</span> <span class="nav-text"> 加速度计坐标轴</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#右手与左手的旋转与加速度计坐标关系"><span class="nav-number">4.2.</span> <span class="nav-text"> 右手与左手的旋转与加速度计坐标关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#int2_ths-阈值寄存器"><span class="nav-number">4.3.</span> <span class="nav-text"> INT2_THS 阈值寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#那么旋转oled阈值事件到底是以x还是z轴触发判断"><span class="nav-number">4.4.</span> <span class="nav-text"> 那么旋转oled阈值事件到底是以x还是z轴触发判断？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#int2_duration寄存器有没有用"><span class="nav-number">4.5.</span> <span class="nav-text"> INT2_DURATION寄存器有没有用？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运动检测"><span class="nav-number">5.</span> <span class="nav-text"> 运动检测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#综合测试"><span class="nav-number">6.</span> <span class="nav-text"> 综合测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关链接"><span class="nav-number">7.</span> <span class="nav-text"> 相关链接</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>




        

<div id="days"></div>
<script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("07/19/2019 15:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="(∩•̀ω•́)⊃--*⋆本站由米板1代搭建，已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒";
}
function setzero(i) {
    if (i<10) {
        i="0" + i
    };
    return i;
}
show_date_time();
</script>




      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">过气德国佬</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">135k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:03</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.3.0</div>

        








        
      </div>
    </footer>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.3.0"></script><script src="/js/motion.js?v=7.3.0"></script>
<script src="/js/schemes/pisces.js?v=7.3.0"></script>
<script src="/js/next-boot.js?v=7.3.0"></script>



  













  <script src="/js/local-search.js?v=7.3.0"></script>














  

  
    
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    
  

  

  


  
  <script src="/js/scrollspy.js?v=7.3.0"></script><script src="/js/post-details.js?v=7.3.0"></script>



<script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: true,
    notify: true,
    appId: 'iWuakuHkkRt5xT7Ct9cyj8nO-gzGzoHsz',
    appKey: 'PAz23pDzHnucqRDkVMShMp5B',
    placeholder: '(๑•̀ㅁ•́ฅ✧ 说点什么吧！',
    avatar: '',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn',
    path: location.pathname
  });
}, window.Valine);
</script>

</body>
</html>
